# Описание проекта
## Этот проект представляет собой REST API микросервис для работы с медиафайлами.
## Микросервис предоставляет функциональность для загрузки файлов на сервер, сохранения их в локальном хранилище, асинхронной загрузки копий в облачное хранилище, а также для скачивания файлов по уникальному идентификатору (UID).

## Технологии
1. FastAPI: Фреймворк для создания веб-приложений и REST API.
2. PostgreSQL: Реляционная база данных для хранения метаданных о файлах.
3. SQLAlchemy: ORM для работы с базой данных.
4. HTTPX: HTTP-клиент для асинхронных запросов.
5. Pytest: Фреймворк для тестирования Python-кода.

## Функциональность
- Загрузка файлов: Файлы можно загружать на сервер через HTTP POST-запросы. Каждый файл получает уникальный идентификатор (UID), по которому его можно будет скачать.

- Скачивание файлов: Файлы можно скачать по UID, используя HTTP GET-запрос.

- Асинхронная загрузка в облачное хранилище: После загрузки файла на сервер, его копия асинхронно отправляется в облачное хранилище.

- Удаление старых файлов: Скрипт для удаления файлов, старше определенного количества дней.

## Установка и запуск
1. Клонирование репозитория:
```bash
git clone https://github.com/atomsis/media-file-service.git
```

2. Создание и активация виртуального окружения:
```bash
python3 -m venv .venv
source .venv/bin/activate  # Для Windows: .venv\Scripts\activate
```

3. Установка зависимостей:
```bash
pip install -r requirements.txt
```

4. Настройка базы данных:
Убедитесь, что PostgreSQL запущен и доступен. В файле app/config.py настройте параметры подключения к базе данных.

5. Запуск приложения:
```bash
uvicorn app.main:app --reload
```
6. Запуск тестов:
- Нажмите правой кнопкой мыши по test_main.py(если вы в pycharm) и выбирете "Run Python tests". Либо любым другим способом запустите файл test_main.py 

## Проверка хранилища
##### Я решил воспользоваться облачком от Selectel.
##### Правда за время тестирования заметил что он странно отображает элементы хранящиеся в облаке(этот косяк только в выделенной сайтом страничке)
##### Если загрузите в облако 3-4 файла(видео/фото/etc) и будете обновлять страницу=он будет отображать разное количество файлов
##### (баг не мой а хранилища,которым пользуется САМ самокат(который доставка еды)((факт))))(но это и понятно -это отображение чисто для разработки)
Для проверки сохраненных файлов в облачном хранилище, перейдите по следующей ссылке: [Cloud Storage](https://d2001c60-7396-4401-a291-ca3ea645513c.selstorage.ru/).

### Настройка автоматической очистки файлов с помощью Cron
##### Этот проект включает скрипт для очистки старых файлов из директории.
##### Чтобы автоматизировать выполнение этого скрипта, вы можете использовать Cron на Linux-системах.
##### Ниже приведены шаги для настройки Cron, чтобы ваш скрипт автоматически запускался по расписанию.

- Шаг 1: Убедитесь, что скрипт работает
##### Проверьте, что ваш скрипт clean_old_files.py работает корректно. Для этого запустите его вручную:
```bash
python clean_old_files.py
```

##### Убедитесь, что скрипт удаляет старые файлы из директории ./uploads, как ожидается.

- Шаг 2: Откройте Crontab для редактирования
##### Откройте терминал и введите команду для редактирования crontab-файла:
```bash
crontab -e
```
##### Если это первый раз, когда вы используете crontab, вам может быть предложено выбрать текстовый редактор. Выберите предпочитаемый редактор (например, nano).

- Шаг 3: Добавьте задачу Cron
##### Добавьте следующую строку в файл crontab для автоматического выполнения скрипта каждый день в 2:00 ночи:
```bash
0 2 * * * /usr/bin/python3 /path/to/your/project/clean_old_files.py
```
  - 0 2 * * * - Запускает задачу каждый день в 2:00 ночи.
  - /usr/bin/python3 - Путь к интерпретатору Python 3 (проверьте, что это верный путь на вашей системе).
  - /path/to/your/project/clean_old_files.py - Полный путь к вашему скрипту clean_old_files.py. Замените его на фактический путь к вашему скрипту.
Сохраните изменения и выйдите из редактора. В nano, для этого нажмите Ctrl + X, затем Y, и нажмите Enter.

- Шаг 4: Проверьте, что задача Cron была добавлена
##### Проверьте список задач Cron, чтобы убедиться, что ваша задача была успешно добавлена:
```bash
crontab -l
```
##### Вы должны увидеть строку, которую вы только что добавили.

-------------------------------------------------
#### Примечания
###### Убедитесь, что ваш скрипт clean_old_files.py имеет права на выполнение. Если это не так, установите права с помощью команды:
```bash
chmod +x /path/to/your/project/clean_old_files.py
```
##### Проверьте логи Cron, если скрипт не выполняется как ожидалось. Логи могут быть доступны в файле /var/log/syslog или /var/log/cron.log в зависимости от конфигурации вашей системы.

